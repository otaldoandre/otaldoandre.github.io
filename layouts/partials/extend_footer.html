{{- /* Kudos customizado usando eventos do Tinylytics */ -}}
{{- if .IsPage -}}
<div class="kudos-wrapper">
    <button class="kudos-button" id="kudos-btn" aria-label="Curtir">
        <svg class="kudos-circle" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <!-- Círculo de fundo -->
            <circle class="kudos-bg" cx="50" cy="50" r="45" />
            <!-- Círculo de preenchimento -->
            <circle class="kudos-fill" cx="50" cy="50" r="45" />
        </svg>
    </button>
    <div class="kudos-info">
        <span class="kudos-count">0</span>
        <span class="kudos-label">curtidas</span>
    </div>
</div>

<!-- Botão invisível do Tinylytics (necessário para funcionar) -->
<button class="tinylytics_kudos" style="display: none;"></button>

<style>
.kudos-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin: 2.5rem auto;
    max-width: 200px;
}

.kudos-button {
    position: relative;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    width: 60px;
    height: 60px;
    display: block;
    transition: transform 0.2s ease;
    flex-shrink: 0;
}

.kudos-button:hover {
    transform: scale(1.08);
}

.kudos-button:active {
    transform: scale(0.98);
}

.kudos-button.completed {
    cursor: default;
}

.kudos-button.completed:hover {
    transform: scale(1);
}

.kudos-circle {
    width: 100%;
    height: 100%;
}

.kudos-bg {
    fill: none;
    stroke: var(--border, #e0e0e0);
    stroke-width: 3;
}

.kudos-fill {
    fill: var(--primary, #1a73e8);
    opacity: 0;
    transform: scale(0);
    transform-origin: center;
    transition: all 0.05s linear;
}

.kudos-button.filling .kudos-fill {
    opacity: 1;
}

.kudos-button.completed .kudos-fill {
    opacity: 1;
    transform: scale(1);
}

.kudos-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.2rem;
}

.kudos-count {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--content, #333);
    line-height: 1;
}

.kudos-label {
    font-size: 0.8rem;
    color: var(--secondary, #999);
    text-transform: lowercase;
}

.kudos-button.completed ~ .kudos-info .kudos-count,
.kudos-button.completed ~ .kudos-info .kudos-label {
    color: var(--primary, #1a73e8);
}
</style>

<script>
(function() {
    const btn = document.getElementById('kudos-btn');
    const tinylyticsBtn = document.querySelector('.tinylytics_kudos');

    if (!btn || !tinylyticsBtn) return;

    const countEl = btn.parentElement.querySelector('.kudos-count');
    const labelEl = btn.parentElement.querySelector('.kudos-label');
    const fillCircle = btn.querySelector('.kudos-fill');

    const HOVER_DURATION = 1200; // 1.2 segundos
    const currentPath = window.location.pathname;

    let startTime = 0;
    let animationFrame = null;
    let hasGivenKudos = false;
    let currentCount = 0;

    // Verifica se já curtiu
    const storageKey = `kudos_given_${currentPath}`;
    hasGivenKudos = localStorage.getItem(storageKey) === 'true';

    // Aguarda o Tinylytics carregar e pega o contador inicial
    function waitForTinylytics() {
        const checkInterval = setInterval(() => {
            // O Tinylytics injeta o número no botão dele
            const count = tinylyticsBtn.textContent.trim();
            if (count !== '') {
                clearInterval(checkInterval);
                currentCount = parseInt(count) || 0;
                updateCountDisplay();

                if (hasGivenKudos || tinylyticsBtn.classList.contains('did_select')) {
                    btn.classList.add('completed');
                    hasGivenKudos = true;
                }
            }
        }, 100);

        // Timeout de 5 segundos
        setTimeout(() => clearInterval(checkInterval), 5000);
    }

    // Atualiza o display
    function updateCountDisplay() {
        countEl.textContent = currentCount;
        labelEl.textContent = currentCount === 1 ? 'curtida' : 'curtidas';
    }

    // Trigger do kudos via Tinylytics
    function sendKudos() {
        // Clica no botão invisível do Tinylytics
        tinylyticsBtn.click();

        // Atualiza nosso estado
        currentCount++;
        updateCountDisplay();
        localStorage.setItem(storageKey, 'true');
        hasGivenKudos = true;
        btn.classList.add('completed');
    }

    // Animação de preenchimento
    function updateFillProgress() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / HOVER_DURATION, 1);

        fillCircle.style.transform = `scale(${progress})`;

        if (progress < 1) {
            animationFrame = requestAnimationFrame(updateFillProgress);
        } else {
            // Completou!
            sendKudos();
            btn.classList.remove('filling');
        }
    }

    // Eventos do mouse
    btn.addEventListener('mouseenter', () => {
        if (hasGivenKudos) return;

        startTime = Date.now();
        btn.classList.add('filling');
        updateFillProgress();
    });

    btn.addEventListener('mouseleave', () => {
        if (hasGivenKudos) return;

        if (animationFrame) {
            cancelAnimationFrame(animationFrame);
        }
        btn.classList.remove('filling');
        fillCircle.style.transform = 'scale(0)';
    });

    // Touch events para mobile
    btn.addEventListener('touchstart', (e) => {
        if (hasGivenKudos) return;
        e.preventDefault();

        startTime = Date.now();
        btn.classList.add('filling');
        updateFillProgress();
    });

    btn.addEventListener('touchend', () => {
        if (hasGivenKudos) return;

        if (animationFrame) {
            cancelAnimationFrame(animationFrame);
        }
        btn.classList.remove('filling');
        fillCircle.style.transform = 'scale(0)';
    });

    // Inicializa
    waitForTinylytics();
})();
</script>
{{- end -}}